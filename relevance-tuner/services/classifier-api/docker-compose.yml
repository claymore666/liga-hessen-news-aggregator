services:
  classifier:
    build: .
    container_name: liga-classifier
    ports:
      - "8082:8082"
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    environment:
      - CUDA_VISIBLE_DEVICES=0
      - PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True
    volumes:
      # Cache HuggingFace models to avoid re-downloading
      - ~/.cache/huggingface:/root/.cache/huggingface
      # Model file (can be updated without rebuild)
      - ./models:/app/models
      # Vector store persistent data (search index)
      - vectordb-data:/app/data/vectordb
      # Duplicate store persistent data (duplicate detection index)
      - duplicatedb-data:/app/data/duplicatedb
    restart: unless-stopped
    stop_grace_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  vectordb-data:
    name: liga-classifier-vectordb
  duplicatedb-data:
    name: liga-classifier-duplicatedb
